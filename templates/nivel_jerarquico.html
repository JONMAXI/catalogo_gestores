{% extends "base.html" %}

{% block content %}
<h3 class="mb-4">Organigrama por Departamento</h3>

<div class="form-group mb-3">
    <label><strong>Selecciona un departamento:</strong></label>
    <select id="depSelect" class="form-control">
        <option value="">-- Seleccionar --</option>
        {% for id, nombre in departamentos.items() %}
            <option value="{{ id }}">{{ nombre }}</option>
        {% endfor %}
    </select>
</div>

<div class="form-group mb-3">
    <label><strong>Selecciona persona (mÃ¡ximo rango):</strong></label>
    <select id="personaSelect" class="form-control" disabled>
        <option value="">-- Selecciona un departamento primero --</option>
    </select>
</div>

<!-- Resumen por puesto -->
<div id="countPuestos" class="mt-4"></div>

<!-- Organigrama -->
<div id="resultado" class="mt-4"></div>

<!-- Tabla -->
<div id="subordinados" class="mt-4"></div>

<!-- jQuery + DataTables -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
document.getElementById("depSelect").addEventListener("change", function() {
    let dep_id = this.value;
    let personaSelect = document.getElementById("personaSelect");
    personaSelect.innerHTML = "<option>Cargando...</option>";
    personaSelect.disabled = true;

    document.getElementById("resultado").innerHTML = "";
    document.getElementById("countPuestos").innerHTML = "";
    document.getElementById("subordinados").innerHTML = "";

    if (!dep_id) return;

    // 1ï¸âƒ£ Personas del departamento
    fetch("/nivel_jerarquico/personas/" + dep_id)
        .then(res => res.json())
        .then(personas => {
            personaSelect.innerHTML = "";
            if (personas.length === 0) {
                personaSelect.innerHTML = "<option>No hay personas</option>";
                return;
            }
            personaSelect.innerHTML = '<option value="">-- Seleccionar --</option>';
            personas.forEach(p => {
                personaSelect.innerHTML += `<option value="${p.id}">${p.nombre}</option>`;
            });
            personaSelect.disabled = false;
        });

    // 2ï¸âƒ£ Conteo por puesto
    fetch("/nivel_jerarquico/count/" + dep_id)
        .then(res => res.json())
        .then(data => {
            if (!data || data.length === 0) {
                document.getElementById("countPuestos").innerHTML =
                    "<p class='text-muted'>No hay informaciÃ³n de puestos.</p>";
                return;
            }
            let html = `
                <h4 class="mt-4">Resumen por Puesto</h4>
                <table class="table table-bordered table-sm mt-2">
                    <thead class="table-light">
                        <tr>
                            <th>Puesto</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            data.forEach(row => {
                html += `<tr><td>${row.puesto}</td><td><strong>${row.total_empleados}</strong></td></tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById("countPuestos").innerHTML = html;
        });
});

// 3ï¸âƒ£ Carga organigrama y tabla subordinados
document.getElementById("personaSelect").addEventListener("change", function() {
    let persona_id = this.value;
    if (!persona_id) return;

    // Organigrama
    fetch("/nivel_jerarquico/colaborador/" + persona_id)
        .then(res => res.text())
        .then(html => document.getElementById("resultado").innerHTML = html);

    // Tabla subordinados
    fetch("/nivel_jerarquico/colaborador_tabla/" + persona_id)
        .then(res => res.json())
        .then(data => {
            if (!data || data.length === 0) {
                document.getElementById("subordinados").innerHTML =
                    "<p class='text-muted'>No hay empleados bajo esta persona.</p>";
                return;
            }

            // ðŸ”¹ Filtros
            const puestos = [...new Set(data.map(p => p.puesto).filter(Boolean))].sort();
            let filtrosHTML = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label><strong>Filtrar por Puesto:</strong></label>
                        <select id="filtroPuesto" class="form-control">
                            <option value="">-- Todos --</option>
                            ${puestos
                                .filter(p => p !== 'Gestor 1-7')  // <-- Excluye "Gestor 1-7"
                                .map(p => `<option value="${p}">${p}</option>`)
                                .join("")}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label><strong>Filtrar por Colaborador:</strong></label>
                        <select id="filtroColaborador" class="form-control" disabled>
                            <option value="">-- Selecciona un puesto --</option>
                        </select>
                    </div>
                </div>
            `;

            // ðŸ”¹ Tabla
            let tablaHTML = `
                <div class="table-wrapper">
                    <table id="subordinadosTable" class="table table-striped table-bordered table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Nombre Completo</th>
                                <th>Departamento</th>
                                <th>Puesto</th>
                                <th>Estatus</th>
                                <th>Nombre Jefe</th>
                                <th>Puesto Jefe</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            data.forEach(p => {
                tablaHTML += `
                    <tr>
                        <td>${p.nombre_completo}</td>
                        <td>${p.departamento || ''}</td>
                        <td>${p.puesto || ''}</td>
                        <td>${p.estatus || ''}</td>
                        <td>${p.nombre_jefe || ''}</td>
                        <td>${p.puesto_jefe || ''}</td>
                        <td>
                            <a href="/editar_persona/${p.id}" class="btn btn-sm btn-warning mb-1" title="Editar">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </a>
                            <a href="/documentacion_persona/${p.id}" class="btn btn-sm btn-info mb-1" title="DocumentaciÃ³n">
                                <i class="fa-solid fa-file"></i>
                            </a>
                            ${p.estatus !== 'Baja' ? `
                            <a href="/baja_persona/${p.id}" class="btn btn-sm btn-danger mb-1" title="Dar de Baja">
                                <i class="fa-solid fa-user-slash"></i>
                            </a>` : ''}
                        </td>
                    </tr>
                `;
            });
            tablaHTML += `</tbody></table></div>`;

            // ðŸ”¹ Mostrar todo
            document.getElementById("subordinados").innerHTML = `
                <h4 class="mt-4">Empleados bajo ${this.options[this.selectedIndex].text}</h4>
                ${filtrosHTML}
                ${tablaHTML}
            `;

            // DataTable
            const table = $('#subordinadosTable').DataTable({
                "language": {
                    "search": "Buscar:",
                    "lengthMenu": "Mostrar _MENU_ registros",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ registros",
                    "paginate": {
                        "first": "Primero",
                        "last": "Ãšltimo",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                "pageLength": 10
            });

            // ðŸ”¹ Filtro por puesto
            $('#filtroPuesto').on('change', function() {
                const puesto = $(this).val();
                table.columns(5).search(puesto).draw();

                const colaboradorSelect = $('#filtroColaborador');
                colaboradorSelect.html('');
                if (!puesto) {
                    colaboradorSelect.html('<option value="">-- Selecciona un puesto --</option>');
                    colaboradorSelect.prop('disabled', true);
                    return;
                }

                const colaboradores = [...new Set(data
                    .filter(p => p.puesto === puesto)
                    .map(p => p.nombre_completo)
                    .filter(Boolean)
                )].sort();

                colaboradorSelect.html('<option value="">-- Todos --</option>');
                colaboradores.forEach(nombre => {
                    colaboradorSelect.append(`<option value="${nombre}">${nombre}</option>`);
                });
                colaboradorSelect.prop('disabled', false);
            });

            // ðŸ”¹ Filtro por colaborador (Nombre Jefe)
            $('#filtroColaborador').on('change', function() {
                const nombreSeleccionado = $(this).val();

                if (!nombreSeleccionado) {
                    table.columns(4).search('').draw();
                    return;
                }

                // Coincidencia exacta con el campo "Nombre Jefe"
                table.columns(4).search('^' + nombreSeleccionado + '$', true, false).draw();
            });
        });
});
</script>
{% endblock %}
